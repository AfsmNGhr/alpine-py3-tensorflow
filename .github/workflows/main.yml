name: Tensorflow for Alpine linux

on:
  push:

jobs:
  builder:
    name: Run multi-stage build
    runs-on: ubuntu-latest
    env:
      ALPINE_PYTHON_IMAGE: python:3.7.6-alpine3.11
      TF_VERSION: 2.1.0
      PACKAGE_NAME: afsmnghr/alpine-tensorflow/alpine-tensorflow
    steps:

      - name: Checkout
        uses: actions/checkout@v1
        with:
          fetch-depth: 1

      - name: Base stage
        uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: ${{ format('{0}:{1}-base', env.PACKAGE_NAME, env.TF_VERSION) }}
          username: ${{ github.actor }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          registry: docker.pkg.github.com
          buildoptions: '--target base'
          buildargs: ALPINE_PYTHON_IMAGE, TF_VERSION
          cache: true

      - name: Build-base stage
        uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: ${{ format('{0}:{1}-build-base', env.PACKAGE_NAME, env.TF_VERSION) }}
          username: ${{ github.actor }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          registry: docker.pkg.github.com
          buildoptions: '--target build-base'
          buildargs: ALPINE_PYTHON_IMAGE, TF_VERSION
          cache: true

      - name: Compile stage
        uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: ${{ format('{0}:{1}-compile', env.PACKAGE_NAME, env.TF_VERSION) }}
          username: ${{ github.actor }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          registry: docker.pkg.github.com
          buildoptions: '--target compile'
          buildargs: ALPINE_PYTHON_IMAGE, TF_VERSION
          cache: true

      - name: Release stage
        uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: ${{ format('{0}:{1}', env.PACKAGE_NAME, env.TF_VERSION) }}
          username: ${{ github.actor }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          registry: docker.pkg.github.com
          buildoptions: '--target release'
          buildargs: ALPINE_PYTHON_IMAGE, TF_VERSION
          cache: true
