name: Build wheel for alpine

on:
  push:

jobs:
  build:
    name: Multi-stage build
    runs-on: ubuntu-latest
    env:
      ALPINE_PYTHON_IMAGE: python:3.7.6-alpine3.11
      TF_VERSION: 1.13.2
      TF_BUILD_OPTIONS: --config opt
      LOCAL_RESOURCES: 4096,8.0,1.0
      PACKAGE_NAME: afsmnghr/alpine-tensorflow/alpine-tensorflow
    steps:

      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 1

      - name: Base stage
        uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: ${{ format('{0}:{1}-base', env.PACKAGE_NAME, env.TF_VERSION) }}
          username: ${{ github.actor }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          registry: docker.pkg.github.com
          buildoptions: '--target base'
          buildargs: ALPINE_PYTHON_IMAGE
          cache: true

      - name: Build-base stage
        uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: ${{ format('{0}:{1}-build-base', env.PACKAGE_NAME, env.TF_VERSION) }}
          username: ${{ github.actor }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          registry: docker.pkg.github.com
          buildoptions: '--target build-base'
          cache: true

      - name: Compile stage
        uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: ${{ format('{0}:{1}-compile', env.PACKAGE_NAME, env.TF_VERSION) }}
          username: ${{ github.actor }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          registry: docker.pkg.github.com
          buildoptions: --target compile --cache-from=${{ format('docker.pkg.github.com/{0}:{1}-build-base', env.PACKAGE_NAME, env.TF_VERSION) }}
          buildargs: TF_VERSION, TF_BUILD_OPTIONS, LOCAL_RESOURCES
          cache: true

      - name: Release stage
        uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: ${{ format('{0}:{1}', env.PACKAGE_NAME, env.TF_VERSION) }}
          username: ${{ github.actor }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          registry: docker.pkg.github.com
          buildoptions: '--target release'
          cache: true
